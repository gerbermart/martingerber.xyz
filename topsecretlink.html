<!DOCTYPE html>
<html>
<head>
    <title>ETH Mint Landing Page</title>
    <meta name="description" content="come explore the music & artwork of Martin Gerber (aka Marty Gerbs)">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta property="og:title" content="Martin Gerber aka Marty Gerbs">
    <meta property="og:type" content="article" />
    <meta property="og:description" content="come explore the music & artwork of Martin Gerber (aka Marty Gerbs)">
    <meta property="og:image" content="https://martingerber.xyz/card.jpg">
    <meta property="og:url" content="https://martingerber.xyz/index.html">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style_mint.css">
</head>

<body>
    <div id="video-background">
        <video id="video-content" autoplay loop muted playsinline>
            <source src="IMAGES/MINT.mp4" type="video/mp4">
        </video>
        <div class="content-container">
            <div class="buttons-container">
                <div class="title">GOERLI mint is LIVE!</div>
                <div class="button-and-input-container">
                    <a onclick="mintAlbum()" id="mintAlbumBtn" class="button" target="_blank" rel="noopener noreferrer">MINT (0.01 GOERLI)</a>
                    <input type="number" id="mintCountInput" class="input" placeholder="Mint Count" value="1">
                </div>
                <br><br>
                <a onclick="freeMint()" id="freeMintBtn" class="button" target="_blank" rel="noopener noreferrer">MINT (FREE FOR ALLOWLIST)</a>
                <br><br>
                <a href="https://testnets.opensea.io/assets/goerli/0xbb1696ed7CE36a50a947e20F3785DE11460AEcEe/1" class="button" target="_blank" rel="noopener noreferrer">VIEW ON OPENSEA</a>
            </div>
        </div>
    </div>

    <script>
        const ethereumProvider = window.ethereum;
        ethereumProvider.chainId = '0x5'; // Goerli chain ID

        async function estimateGasLimit(transactionParameters) {
            try {
                const gasLimit = await ethereumProvider.request({ method: 'eth_estimateGas', params: [transactionParameters] });
                return gasLimit;
            } catch (error) {
                console.error('Error estimating gas limit:', error);
                throw error;
            }
        }

        async function sendTransaction(transactionParameters) {
            try {
                const result = await ethereumProvider.request({ method: 'eth_sendTransaction', params: [transactionParameters] });
                console.log('Transaction result:', result);
                return result;
            } catch (error) {
                console.error('Error sending transaction:', error);
                throw error;
            }
        }

        async function updateButtonText(buttonId, newText, txHash) {
            const button = document.getElementById(buttonId);
            if (button) {
                const buttonLink = document.createElement('a');
                if (txHash !== undefined && txHash !== 'error') {
                    buttonLink.href = `https://goerli.etherscan.io/tx/${txHash}`;
                }
                buttonLink.textContent = newText;
                buttonLink.target = '_blank';
                buttonLink.rel = 'noopener noreferrer';
                button.textContent = '';
                button.onclick = null;
                button.appendChild(buttonLink);

                // Change the message to "MINT COMPLETE" if the transaction was successful
                if (newText === 'MINT COMPLETE!') {
                    const mintCompleteMessage = document.createElement('p');
                    mintCompleteMessage.textContent = 'MINT COMPLETE!';
                    mintCompleteMessage.style.color = '#2b8c00';
                    mintCompleteMessage.style.fontWeight = 'bold';
                    button.parentNode.appendChild(mintCompleteMessage);

                    // Change the video source to "CELEBRATE.mp4"
                    const videoContainer = document.getElementById('video-background');
                    const videoElement = document.getElementById('video-content');
                    videoElement.src = 'IMAGES/CELEBRATE.mp4';
                    videoContainer.style.background = 'transparent';
                }
            }
        }

        ethereumProvider.on('transactionHash', async (txHash) => {
            // Transaction hash received, update the button text accordingly
            await updateButtonText('mintAlbumBtn', 'MINT COMPLETE', txHash);
            await updateButtonText('freeMintBtn', 'MINT COMPLETE', txHash);

            // Wait for transaction confirmation
            ethereumProvider.once('confirmation', (confirmationNumber, receipt) => {
                if (receipt.transactionHash === txHash) {
                    // Transaction confirmed, update the button text to indicate completion
                    updateButtonText('mintAlbumBtn', 'MINT COMPLETE!', txHash);
                    updateButtonText('freeMintBtn', 'MINT COMPLETE!', txHash);
                }
            });
        });

        async function freeMint() {
            try {
                // Request access to the user's Ethereum accounts
                await ethereumProvider.request({ method: 'eth_requestAccounts' });

                const contractAddress = '0xbb1696ed7CE36a50a947e20F3785DE11460AEcEe'; // Replace with your contract address on the Goerli chain

                const tokenNum = 1; // Replace with the desired token number
                const mintCount = 1; // Replace with the desired mint count

                const tokenNumHex = '0x' + tokenNum.toString(16);
                const mintCountHex = '0x' + mintCount.toString(16);

                const functionSelector = '0x91c09d52'; // Function selector for 'freeMint(uint256,uint256)'
                const data = functionSelector + tokenNumHex.slice(2).padStart(64, '0') + mintCountHex.slice(2).padStart(64, '0');

                const transactionParameters = {
                    from: ethereumProvider.selectedAddress,
                    to: contractAddress,
                    data: data
                };

                // Update button text to indicate transaction in progress
                updateButtonText('freeMintBtn', 'TX IN PROGRESS', null);

                // Estimate the gas limit
                const gasLimit = await estimateGasLimit(transactionParameters);

                // Add the gas limit to the transaction parameters
                transactionParameters.gas = gasLimit;

                // Send the transaction
                const txHash = await sendTransaction(transactionParameters);

                // Update button text with transaction hash and link
                updateButtonText('freeMintBtn', `TX IN PROGRESS (View on Etherscan)`, txHash);
            } catch (error) {
                console.error('Error during free mint:', error);
                updateButtonText('freeMintBtn', 'ERROR', 'error');
            }
        }

        async function mintAlbum() {
            try {
                // Request access to the user's Ethereum accounts
                await ethereumProvider.request({ method: 'eth_requestAccounts' });

                const contractAddress = '0xbb1696ed7CE36a50a947e20F3785DE11460AEcEe'; // Replace with your contract address on the Goerli chain

                const tokenNum = 1; // Replace with the desired token number
                const mintCount = 1; // Replace with the desired mint count

                const tokenNumHex = '0x' + tokenNum.toString(16);
                const mintCountHex = '0x' + mintCount.toString(16);

                const functionSelector = '0x91c09d52'; // Function selector for 'mintAlbum(uint256,uint256)'
                const data = functionSelector + tokenNumHex.slice(2).padStart(64, '0') + mintCountHex.slice(2).padStart(64, '0');

                const transactionParameters = {
                    from: ethereumProvider.selectedAddress,
                    to: contractAddress,
                    data: data,
                    value: '0x2386f26fc10000' // 0.01 ETH in Wei
                };

                // Update button text to indicate transaction in progress
                updateButtonText('mintAlbumBtn', 'TX IN PROGRESS', null);

                // Estimate the gas limit
                const gasLimit = await estimateGasLimit(transactionParameters);

                // Add the gas limit to the transaction parameters
                transactionParameters.gas = gasLimit;

                // Send the transaction
                const txHash = await sendTransaction(transactionParameters);

                // Update button text with transaction hash and link
                updateButtonText('mintAlbumBtn', `TX IN PROGRESS (View on Etherscan)`, txHash);
            } catch (error) {
                console.error('Error during album mint:', error);
                updateButtonText('mintAlbumBtn', 'ERROR', 'error');
            }
        }
    </script>
</body>
</html>
