<html>
<head>


    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="./sha3.js"></script>
    <script type="text/javascript">
        async function getWaddy(){
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed!');
            }
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const account = accounts[0];
            myWaddy=account.toLowerCase();
            $("#waddyid").html(myWaddy);
        };
        function getOwners(){
            let contracts=['0xB0e5Faac1429592CEA8a70F8828D7bD88b788e82','0xd8FAbd716eCCBF98157f6728D3c187625a513127','0x349dbADc6d24Eb7E534EF230Db01a35208E49d04'];
            let token_trackers=['NORLI','GERBS','BONES'];

            for (k=0;k<3;k++){
                let contract=contracts[k];
                let token_tracker=token_trackers[k];
            
                text='';
                let testWaddy = myWaddy.toLowerCase();
                stopper='no';
                for (let i=1;((i<100) & (stopper=='no'));i++){
                    
                    const url_str='https://api.opensea.io/api/v1/asset/'+contract+'/'+i.toString()+'/owners';
                    const settings = {
                    async: true,
                    crossDomain: true,
                    url: url_str,
                    method: 'GET',
                    headers: {}
                    };
                
                    $(document).ready(function(){
                        $("#msgid").html('doin stuff...');
                        $.ajax(settings).done(function (response) {
                            
                            const json = JSON.stringify(response).replace(/[\r\n]/gm, '');
                            
                            const obj = JSON.parse(json);
                            
                            if (obj.length==0){
                                stopper='no';
                            }
                            
                            for (let j = 0; j < obj.owners.length; j++) {
                            text += token_tracker+'-'+i.toString()+': '+obj.owners[j].owner.address.toString() + "<br>";
                            } 
                            var addresses = text.split('<br>')
                            if ((testWaddy!='') & (addresses.includes(testWaddy))){
                                $("#msgid").html(text+'<br>includes testWaddy');
                                let string = 'BONES_UNLOCKED';
                                $("#linkid").html('<a href="'+sha3_512(string)+'.html">SECRET LINK</a>');
                            } else {
                                $("#msgid").html(text+'<br>does NOT include testWaddy');
                            }
                            
                        });
                        
                    });
                };
            };
        };
        function getHash(){
            
        };
    
    </script>

</head>

<body>

<h1>ETH NFT Owners</h1>


<button type="button" onClick="getWaddy();">Get Waddy</button>

<button type="button" onClick="getOwners();">Get Owners</button>

<p>My Wallet ID (replace w/ WalletConnect):</p>
<div id="waddyid">
</div>
<p>Token Owners & Match Result:</p>
<br>
<div id="msgid">
</div>

<div id="linkid"></div>

</body>
</html>