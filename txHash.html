<!DOCTYPE html>
<html>
<head>
    <title>Mint NFT</title>
    <style>
        .button-container {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .button-container input[type="number"] {
            margin-left: 10px;
            width: 60px;
        }

        .button-container .button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div>
    <h1>Mint NFT</h1>
    <div class="button-container">
        <div>
            <a onclick="mintAlbum()" id="mintAlbumBtn" class="button" target="_blank" rel="noopener noreferrer">MINT ALBUM (0.01 GOERLI)</a>
            <input type="number" id="mintCountInput" placeholder="Mint Count">
            <br><br>
            <a onclick="freeMint()" id="freeMintBtn" class="button" target="_blank" rel="noopener noreferrer">MINT (FREE FOR ALLOWLIST)</a>
            <br><br>
            <a href="https://testnets.opensea.io/assets/goerli/0xbb1696ed7CE36a50a947e20F3785DE11460AEcEe/1" class="button" target="_blank" rel="noopener noreferrer">VIEW ON OPENSEA</a>
        </div>
    </div>
</div>
<script>
    const ethereumProvider = window.ethereum;
    ethereumProvider.chainId = '0x5'; // Goerli chain ID

    async function estimateGasLimit(transactionParameters) {
        try {
            const gasLimit = await ethereumProvider.request({ method: 'eth_estimateGas', params: [transactionParameters] });
            return gasLimit;
        } catch (error) {
            console.error('Error estimating gas limit:', error);
            throw error;
        }
    }

    async function sendTransaction(transactionParameters) {
        try {
            const result = await ethereumProvider.request({ method: 'eth_sendTransaction', params: [transactionParameters] });
            console.log('Transaction result:', result);
            return result;
        } catch (error) {
            console.error('Error sending transaction:', error);
            throw error;
        }
    }

    async function updateButtonText(buttonId, newText, txHash) {
        const button = document.getElementById(buttonId);
        if (button) {
            const buttonLink = document.createElement('a');
            buttonLink.href = `https://goerli.etherscan.io/tx/${txHash}`;
            buttonLink.textContent = newText;
            buttonLink.target = '_blank';
            buttonLink.rel = 'noopener noreferrer';
            button.textContent = '';
            button.appendChild(buttonLink);
        }
    }

    async function freeMint() {
        try {
            // Request access to the user's Ethereum accounts
            await ethereumProvider.request({ method: 'eth_requestAccounts' });

            const contractAddress = '0xbb1696ed7CE36a50a947e20F3785DE11460AEcEe'; // Replace with your contract address on the Goerli chain

            const tokenNum = 1; // Replace with the desired token number
            const mintCountInput = document.getElementById('mintCountInput');
            const mintCount = mintCountInput.value || 1; // Replace with the desired mint count

            const tokenNumHex = '0x' + tokenNum.toString(16);
            const mintCountHex = '0x' + mintCount.toString(16);

            const functionSelector = '0x4cb16ced'; // Function selector for 'mintAlbum(uint256,uint256)'
            const data = functionSelector + tokenNumHex.slice(2).padStart(64, '0') + mintCountHex.slice(2).padStart(64, '0');

            const transactionParameters = {
                from: ethereumProvider.selectedAddress,
                to: contractAddress,
                data: data,
                value: '0x2386f26fc10000' // 0.01 ETH in Wei (0.01 * 10^18)
            };

            // Update button text to indicate transaction in progress
            await updateButtonText('freeMintBtn', 'TX IN PROGRESS');

            // Estimate the gas limit
            const gasLimit = await estimateGasLimit(transactionParameters);

            // Add the gas limit to the transaction parameters
            transactionParameters.gas = gasLimit;

            // Send the transaction
            const txHash = await sendTransaction(transactionParameters);

            // Update button text with transaction hash and link
            await updateButtonText('freeMintBtn', `TX IN PROGRESS (View on Etherscan)`, txHash);
        } catch (error) {
            console.error('Error:', error);
            // Update button text to display the error message from the contract
            await updateButtonText('freeMintBtn', error.message);
        }
    }

    async function mintAlbum() {
        try {
            // Request access to the user's Ethereum accounts
            await ethereumProvider.request({ method: 'eth_requestAccounts' });

            const contractAddress = '0xbb1696ed7CE36a50a947e20F3785DE11460AEcEe'; // Replace with your contract address on the Goerli chain

            const tokenNum = 1; // Replace with the desired token number
            const mintCountInput = document.getElementById('mintCountInput');
            const mintCount = mintCountInput.value || 1; // Replace with the desired mint count

            const tokenNumHex = '0x' + tokenNum.toString(16);
            const mintCountHex = '0x' + mintCount.toString(16);

            const functionSelector = '0x4cb16ced'; // Function selector for 'mintAlbum(uint256,uint256)'
            const data = functionSelector + tokenNumHex.slice(2).padStart(64, '0') + mintCountHex.slice(2).padStart(64, '0');

            const transactionParameters = {
                from: ethereumProvider.selectedAddress,
                to: contractAddress,
                data: data,
                value: '0x2386f26fc10000' // 0.01 ETH in Wei (0.01 * 10^18)
            };

            // Update button text to indicate transaction in progress
            await updateButtonText('mintAlbumBtn', 'TX IN PROGRESS');

            // Estimate the gas limit
            const gasLimit = await estimateGasLimit(transactionParameters);

            // Add the gas limit to the transaction parameters
            transactionParameters.gas = gasLimit;

            // Send the transaction
            const txHash = await sendTransaction(transactionParameters);

            // Update button text with transaction hash and link
            await updateButtonText('mintAlbumBtn', `TX IN PROGRESS (View on Etherscan)`, txHash);
        } catch (error) {
            console.error('Error:', error);
            // Update button text to display the error message from the contract
            await updateButtonText('mintAlbumBtn', error.message);
        }
    }
</script>
</body>
</html>
